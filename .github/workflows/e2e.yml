name: E2E tests

on:
  workflow_call:
    inputs:
      target:
        description: Deployment target; usually PR number, test or prod
        default: ${{ github.event.number }}
        required: false
        type: string

permissions: {}

jobs:
  fam-routing:
    runs-on: ubuntu-24.04
    name: Generate FAM routing
    outputs:
      route: ${{ steps.route.outputs.route }}
    steps:
      - name: FAM routing
        id: route
        run: |
          if [ ${{ github.event_name }} == 'pull_request' ]; then
            echo "route=$(( ${{ inputs.target }} % 50 ))" >> $GITHUB_OUTPUT
          else
            echo "route=${{ inputs.target }}" >> $GITHUB_OUTPUT
          fi

  tests-frontend-dev-coverage:
    name: E2E with frontend coverage
    if: inputs.target != 'prod' && inputs.target != 'PROD'
    runs-on: ubuntu-24.04
    env:
      VITE_ZONE: TEST
      VITE_USER_POOLS_ID: ${{ vars.VITE_USER_POOLS_ID }}
      VITE_USER_POOLS_WEB_CLIENT_ID: ${{ vars.VITE_USER_POOLS_WEB_CLIENT_ID }}
      VITE_BACKEND_URL: https://${{ github.event.repository.name }}-${{ inputs.target }}-backend.apps.silver.devops.gov.bc.ca
    steps:
      - uses: bcgov/action-test-and-analyse@e2ba34132662c1638dbde806064eb7004b3761c3 # v1.3.0
        with:
          commands: |
            npm ci
            npx playwright install chromium
            npm run e2e:ci:dev
          dir: frontend
          node_version: "20"
          sonar_args: >
            -Dsonar.organization=bcgov-sonarcloud
            -Dsonar.projectKey=nr-silva-frontend
            -Dsonar.javascript.lcov.reportPaths=.nyc_output/coverage/lcov.info
            -Dsonar.typescript.tsconfigPaths=tsconfig.json
            -Dsonar.sources=src/
            -Dsonar.exclusions=src/__test__/**,src/amplifyconfiguration.*,src/**/*.scss,src/**/*.css,src/**/*.d.*,src/setupTests.*,src/__e2e__/**,
            -Dsonar.tests=src/__e2e__/
            -Dsonar.project.monorepo.enabled=true
          sonar_token: ${{ secrets.SONAR_TOKEN_FRONTEND }}
          triggers: ${{ github.event_name == 'pull_request' && '("frontend/")' || '' }}
        env:
          VITE_ZONE: TEST
          VITE_USER_POOLS_ID: ${{ vars.VITE_USER_POOLS_ID }}
          VITE_USER_POOLS_WEB_CLIENT_ID: ${{ vars.VITE_USER_POOLS_WEB_CLIENT_ID }}
          VITE_BACKEND_URL: https://${{ github.event.repository.name }}-${{ inputs.target }}-backend.apps.silver.devops.gov.bc.ca
          TEST_BCEID_USERNAME: ${{ secrets.TEST_BCEID_USERNAME }}
          TEST_BCEID_PASSWORD: ${{ secrets.TEST_BCEID_PASSWORD }}

      - name: Check test-results exists
        run: ls frontend || echo "Not found"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: E2E on dev server for coverage test results
          path: frontend/test-results/

  tests-frontend-e2e-built:
    name: E2E with built frontend and backend
    if: inputs.target != 'prod' && inputs.target != 'PROD'
    needs: [fam-routing]
    runs-on: ubuntu-24.04
    env:
      VITE_ZONE: TEST
      VITE_USER_POOLS_ID: ${{ vars.VITE_USER_POOLS_ID }}
      VITE_USER_POOLS_WEB_CLIENT_ID: ${{ vars.VITE_USER_POOLS_WEB_CLIENT_ID }}
      VITE_BACKEND_URL: https://${{ github.event.repository.name }}-${{ inputs.target }}-backend.apps.silver.devops.gov.bc.ca
      BASE_URL: https://${{ github.event.repository.name }}-${{ needs.fam-routing.outputs.route }}-frontend.apps.silver.devops.gov.bc.ca
      TEST_BCEID_USERNAME: ${{ secrets.TEST_BCEID_USERNAME }}
      TEST_BCEID_PASSWORD: ${{ secrets.TEST_BCEID_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci
        working-directory: frontend

      - name: Install Playwright Browsers
        run: npx playwright install chromium
        working-directory: frontend

      - name: Run E2E Tests
        run: npm run e2e:ci:build
        working-directory: frontend

      - name: Check test-results exists
        run: ls frontend || echo "Not found"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: E2E on built apps test results
          path: frontend/test-results/
