name: 'Allocate FAM Route Numbers'
description: 'Finds the next two available FAM routes using bcgov/action-oc-runner'
inputs:
  oc_token:
    required: true
    description: OpenShift token
  oc_namespace:
    required: true
    description: OpenShift namespace
  oc_server:
    required: true
    description: OpenShift server
  pr_number:
    required: true
    description: PR number
outputs:
  route_hybrid:
    description: 'First available FAM route number'
    value: ${{ steps.allocate.export.route_hybrid }}
  route_postgres:
    description: 'Second available FAM route number'
    value: ${{ steps.allocate.export.route_postgres }}
runs:
  using: 'composite'
  steps:
    - name: Find next two available FAM routes
      id: allocate
      uses: bcgov/action-oc-runner@v1.4.0
      with:
        oc_namespace: ${{ inputs.oc_namespace }}
        oc_server: ${{ inputs.oc_server }}
        oc_token: ${{ inputs.oc_token }}
        commands: |
          allocated=$(oc get routes -o json | jq -r '.items[].spec.host' | grep -- '-frontend' | grep -o '[0-9]\+' | sort -n | uniq)
          echo "Allocated routes: $allocated"
          used=($(echo "$allocated"))
          available=()
          for i in $(seq 0 49); do
            if [[ ! " ${used[@]} " =~ " $i " ]]; then
              available+=($i)
            fi
          done
          if [[ ${#available[@]} -lt 2 ]]; then
            echo "Not enough available routes!" >&2
            exit 1
          fi
          echo "commands=route_hybrid=${available[0]},route_postgres=${available[1]}" >> "$GITHUB_OUTPUT"
    
    - name: Export FAM route outputs
      id: export
      shell: bash
      run: |
        route_hybrid=$(echo "${{ steps.allocate.outputs.commands }}" | grep -o 'route_hybrid=[^,]*' | cut -d'=' -f2)
        route_postgres=$(echo "${{ steps.allocate.outputs.commands }}" | grep -o 'route_postgres=[^,]*' | cut -d'=' -f2)
        echo "route_hybrid=$route_hybrid" >> $GITHUB_OUTPUT
        echo "route_postgres=$route_postgres" >> $GITHUB_OUTPUT
