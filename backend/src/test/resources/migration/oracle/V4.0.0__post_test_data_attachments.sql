-- Create temporary table with same column names as THE.OPENING_ATTACHMENT
CREATE GLOBAL TEMPORARY TABLE TEMP_ATTACHMENT_FILE (
  TEMP_ATTACHMENT_FILE_ID NUMBER(10, 0) PRIMARY KEY,
  ATTACHMENT_NAME VARCHAR2(50),
  ATTACHMENT_DESCRIPTION VARCHAR2(120),
  MIME_TYPE_CODE VARCHAR2(3),
  ATTACHMENT_DATA BLOB
) ON COMMIT PRESERVE ROWS;

-- Insert dummy files
INSERT INTO
  TEMP_ATTACHMENT_FILE (
    TEMP_ATTACHMENT_FILE_ID,
    ATTACHMENT_NAME,
    ATTACHMENT_DESCRIPTION,
    MIME_TYPE_CODE,
    ATTACHMENT_DATA
  )
VALUES
  (
    1,
    'PDF_Test_File.pdf',
    'Dummy PDF file',
    'PDF',
    HEXTORAW(
      '255044462D312E330A25938C8B9E205265706F72744C61622047656E6572617465642050444620646F63756D656E7420687474703A2F2F7777772E7265706F72746C61622E636F6D0A312030206F626A0A3C3C0A2F46312032203020520A3E3E0A656E646F626A0A322030206F626A0A3C3C0A2F42617365466F6E74202F48656C766574696361202F456E636F64696E67202F57696E416E7369456E636F64696E67202F4E616D65202F4631202F53756274797065202F5479706531202F54797065202F466F6E740A3E3E0A656E646F626A0A332030206F626A0A3C3C0A2F436F6E74656E7473203720302052202F4D65646961426F78205B20302030203539352E32373536203834312E38383938205D202F506172656E74203620302052202F5265736F7572636573203C3C0A2F466F6E74203120302052202F50726F63536574205B202F504446202F54657874202F496D61676542202F496D61676543202F496D61676549205D0A3E3E202F526F746174652030202F5472616E73203C3C0A0A3E3E200A20202F54797065202F506167650A3E3E0A656E646F626A0A342030206F626A0A3C3C0A2F506167654D6F6465202F5573654E6F6E65202F5061676573203620302052202F54797065202F436174616C6F670A3E3E0A656E646F626A0A352030206F626A0A3C3C0A2F417574686F722028616E6F6E796D6F757329202F4372656174696F6E446174652028443A32303235303730333137333634362B30302730302729202F43726561746F7220285265706F72744C616220504446204C696272617279202D207777772E7265706F72746C61622E636F6D29202F4B6579776F726473202829202F4D6F64446174652028443A32303235303730333137333634362B30302730302729202F50726F647563657220285265706F72744C616220504446204C696272617279202D207777772E7265706F72746C61622E636F6D29200A20202F5375626A6563742028756E73706563696669656429202F5469746C652028756E7469746C656429202F54726170706564202F46616C73650A3E3E0A656E646F626A0A362030206F626A0A3C3C0A2F436F756E742031202F4B696473205B203320302052205D202F54797065202F50616765730A3E3E0A656E646F626A0A372030206F626A0A3C3C0A2F46696C746572205B202F415343494938354465636F6465202F466C6174654465636F6465205D202F4C656E677468203131360A3E3E0A73747265616D0A476170404430622D4836274C5B3B4747553836543F5C69254038746C227226305A6B3347342D4D474131224C495D4665743B487341692C392724325464326370704B322E416F562D534F4D584A4B5C616C482F5D59222F755A4A245E235E526D2C75274D216B6C744F493F4860542B3B58507E3E656E6473747265616D0A656E646F626A0A787265660A3020380A303030303030303030302036353533352066200A30303030303030303733203030303030206E200A30303030303030313034203030303030206E200A30303030303030323131203030303030206E200A30303030303030343134203030303030206E200A30303030303030343832203030303030206E200A30303030303030373738203030303030206E200A30303030303030383337203030303030206E200A747261696C65720A3C3C0A2F4944200A5B3C35303866333931656130323963393031633163306136343365333463336532323E3C35303866333931656130323963393031633163306136343365333463336532323E5D0A25205265706F72744C61622067656E6572617465642050444620646F63756D656E74202D2D206469676573742028687474703A2F2F7777772E7265706F72746C61622E636F6D290A0A2F496E666F2035203020520A2F526F6F742034203020520A2F53697A6520380A3E3E0A7374617274787265660A313034330A2525454F460A'
    )
  );

INSERT INTO
  TEMP_ATTACHMENT_FILE (
    TEMP_ATTACHMENT_FILE_ID,
    ATTACHMENT_NAME,
    ATTACHMENT_DESCRIPTION,
    MIME_TYPE_CODE,
    ATTACHMENT_DATA
  )
VALUES
  (
    2,
    'TXT_Test_File.txt',
    'TXT Test File',
    'TXT',
    HEXTORAW('747874')
  );

INSERT INTO
  TEMP_ATTACHMENT_FILE (
    TEMP_ATTACHMENT_FILE_ID,
    ATTACHMENT_NAME,
    ATTACHMENT_DESCRIPTION,
    MIME_TYPE_CODE,
    ATTACHMENT_DATA
  )
VALUES
  (
    3,
    'JPG_Test_File.jpg',
    'Dummy JPG file',
    'JPG',
    HEXTORAW(
      'FFD8FFE000104A46494600010100000100010000FFDB004300080606070605080707070909080A0C140D0C0B0B0C1912130F141D1A1F1E1D1A1C1C20242E2720222C231C1C2837292C30313434341F27393D38323C2E333432FFDB0043010909090C0B0C180D0D1832211C213232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232323232FFC00011080064006403012200021101031101FFC4001F0000010501010101010100000000000000000102030405060708090A0BFFC400B5100002010303020403050504040000017D01020300041105122131410613516107227114328191A1082342B1C11552D1F02433627282090A161718191A25262728292A3435363738393A434445464748494A535455565758595A636465666768696A737475767778797A838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE1E2E3E4E5E6E7E8E9EAF1F2F3F4F5F6F7F8F9FAFFC4001F0100030101010101010101010000000000000102030405060708090A0BFFC400B51100020102040403040705040400010277000102031104052131061241510761711322328108144291A1B1C109233352F0156272D10A162434E125F11718191A262728292A35363738393A434445464748494A535455565758595A636465666768696A737475767778797A82838485868788898A92939495969798999AA2A3A4A5A6A7A8A9AAB2B3B4B5B6B7B8B9BAC2C3C4C5C6C7C8C9CAD2D3D4D5D6D7D8D9DAE2E3E4E5E6E7E8E9EAF2F3F4F5F6F7F8F9FAFFDA000C03010002110311003F00F1CA28A2BF713CC0A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28A2800A28AEC6D342F0FFF00C2B56F115E2EA7F6CFB749A7A88678FCBF33C93246E54A676E76A91BB38C907F86B1AD5E34527257BBB6834AE71D457A06B3F0D6D342D46C2C6F7C57A64334B7296D78B2119B7DD187F302862C5392BB9C47CED270A770D5B0F871A569D7FAD47AB3DEDD59A6873DF58DE2C0A2393691FBD8CA4E43E01421588C87F982F1BB8A59BE11414D4AF7D568F5F4BFF56D4AF6723CAA8AB7A9D8CBA66A53D9CD0DCC2F1B6025D42619769E54B21276920838C9EBD4F5AA95E9464A49496CC90A28A298828A28A0028A28A0028A28A002AF7F6D6ABFD95FD95FDA77BFD9DFF3E9E7B795F7B77DCCE3EF73D3AF35468A994632B732BD866AA789FC411C76D1A6B9A9AC76B8FB3AADDC8043852A360CFCBF292BC76245324F10EB52EA516A526B1A83DFC4BB23BA6B9732A2F3C07CE40F99B8CF73EB59B4547B0A5BF2AFB82EC9279E5B99E49E795E59A562F249231667627249279249EF51D1456895B4420A28A2980514514005145140051451400514514005145140051451400514514005145140051451400514514005145140051451400514514005145140051451400514514005145140051451400514514005145140051451400514514005145140051451401FFFD9'
    )
  );

INSERT INTO
  TEMP_ATTACHMENT_FILE (
    TEMP_ATTACHMENT_FILE_ID,
    ATTACHMENT_NAME,
    ATTACHMENT_DESCRIPTION,
    MIME_TYPE_CODE,
    ATTACHMENT_DATA
  )
VALUES
  (
    4,
    'CSV_Test_File.jpg',
    'Dummy CSV file',
    'CSV',
    HEXTORAW('6373762c6578616d706c652c64617461')
  );

-- Insert all temp files into THE.OPENING_ATTACHMENT for every existing OPENING_ID
-- Use randomized revision count, timestamps, and user ID
INSERT INTO THE.OPENING_ATTACHMENT (
  OPENING_ATTACHMENT_FILE_ID,
  OPENING_ID,
  ATTACHMENT_NAME,
  ATTACHMENT_DESCRIPTION,
  MIME_TYPE_CODE,
  ATTACHMENT_DATA,
  ENTRY_USERID,
  ENTRY_TIMESTAMP,
  UPDATE_USERID,
  UPDATE_TIMESTAMP,
  REVISION_COUNT,
  OPENING_ATTACHMENT_GUID
)
SELECT
  (SELECT NVL(MAX(OPENING_ATTACHMENT_FILE_ID), 0) FROM THE.OPENING_ATTACHMENT) + ROWNUM,
  b.OPENING_ID,
  b.ATTACHMENT_NAME,
  b.ATTACHMENT_DESCRIPTION,
  b.MIME_TYPE_CODE,
  b.ATTACHMENT_DATA,
  'IDIR\' || ep.NAME,
  SYSDATE - DBMS_RANDOM.VALUE(30, 730),
  'IDIR\' || up.NAME,
  SYSDATE - DBMS_RANDOM.VALUE(30, 730),
  TRUNC(DBMS_RANDOM.VALUE(1, 11)),
  SYS_GUID()
FROM (
  SELECT
    t.ATTACHMENT_NAME,
    t.ATTACHMENT_DESCRIPTION,
    t.MIME_TYPE_CODE,
    t.ATTACHMENT_DATA,
    o.OPENING_ID,
    TRUNC(DBMS_RANDOM.VALUE(1, 9)) AS ENTRY_IDX,
    TRUNC(DBMS_RANDOM.VALUE(1, 9)) AS UPDATE_IDX
  FROM TEMP_ATTACHMENT_FILE t
  CROSS JOIN THE.OPENING o
) b
JOIN (
  SELECT ROWNUM AS IDX, COLUMN_VALUE AS NAME
  FROM TABLE(SYS.ODCIVARCHAR2LIST('DOBBY', 'SNAPE', 'HEDWIG', 'TONKS', 'LUPIN', 'MOLLY', 'SIRIUS', 'HAGRID'))
) ep ON b.ENTRY_IDX = ep.IDX
JOIN (
  SELECT ROWNUM AS IDX, COLUMN_VALUE AS NAME
  FROM TABLE(SYS.ODCIVARCHAR2LIST('DOBBY', 'SNAPE', 'HEDWIG', 'TONKS', 'LUPIN', 'MOLLY', 'SIRIUS', 'HAGRID'))
) up ON b.UPDATE_IDX = up.IDX;

TRUNCATE TABLE TEMP_ATTACHMENT_FILE;
