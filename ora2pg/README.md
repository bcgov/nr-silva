# ora2pg — local migration helper

Summary
-------
This folder holds SQL exported by Ora2Pg and small helper scripts to run a local PostGIS instance and apply the generated SQL. Current migration state: the identified tables (RESULTS) have been exported and moved into `schema/tables/table.sql` and related files; indexes, sequences, and foreign keys were also exported and are present under `schema/tables/INDEXES_table.sql`, `schema/sequences/` (and `schema/sequence_values/`), and `schema/tables/FKEYS_table.sql`. Use the scripts below to recreate, reset or re-run the migration against a local PostGIS instance.

Prerequisites
-------------
- Docker installed and running on your Mac
- (Optional) `psql` client if you want to run the host-based migration script (`postgis-oc-migrate.sh`) instead of container-based
- Basic shell (sh / bash) to execute scripts in this folder

Top-level files & purpose
-------------------------
- config/ora2pg.conf — Ora2Pg export configuration (set SCHEMA / PG_SCHEMA / PRESERVE_CASE etc.)
- config/app_tables.txt — optional list of tables to filter exports/reports
- schema/ — SQL files produced by Ora2Pg (tables, sequences, constraints, indexes, functions, views, ...)

Scripts (what they do & how to use)
-----------------------------------

1) export_schema.sh
- Generated by Ora2Pg. Exports all object types defined in `EXPORT_TYPE` in the script to `schema/` and writes reports to `reports/`.
- Use when running Ora2Pg natively on the host.
- Usage:
  - chmod +x export_schema.sh
  - ./export_schema.sh

2) export_schema_docker.sh
- Same as `export_schema.sh` but runs Ora2Pg in a Docker image (`georgmoser/ora2pg`). Useful if you do not have Ora2Pg locally.
- It mounts the repo into the container and writes outputs into the repo.
- Usage:
  - chmod +x export_schema_docker.sh
  - ./export_schema_docker.sh

3) export_schema_filter_tables_docker.sh
- Dockerized export but limited to tables listed in `config/app_tables.txt`. Exports only TABLE objects (and related table-level SQL).
- Use when you want a filtered export for reporting or partial migration.
- Usage:
  - Populate `config/app_tables.txt` (comma or space separated as expected by Ora2Pg)
  - chmod +x export_schema_filter_tables_docker.sh
  - ./export_schema_filter_tables_docker.sh

4) generate_reports_docker.sh
- Runs Ora2Pg report commands in Docker:
  - SHOW_TABLE -> reports/tables.txt
  - SHOW_COLUMN -> reports/columns.txt
  - SHOW_REPORT (HTML) -> reports/report.html
- Accepts filtering via `config/app_tables.txt` (script already passes -a "$(cat config/app_tables.txt)").
- Usage:
  - chmod +x generate_reports_docker.sh
  - ./generate_reports_docker.sh

5) postgis-init.sh
- Creates (if missing) a named Docker volume and starts a PostGIS container with the workspace mounted read-only at `/workspace`.
- Configurable variables: VOLUME_NAME, CONTAINER_NAME, IMAGE, POSTGRES_USER, POSTGRES_PASSWORD, POSTGRES_DB, HOST_PORT.
- Example:
  - chmod +x postgis-init.sh
  - ./postgis-init.sh
- Notes:
  - If a data volume already exists from an earlier Postgres major version, PostGIS/Postgres may fail to start (data directory version mismatch). See `postgis-delete.sh` for cleanup options or use logical export/import to migrate data.

6) postgis-migrate.sh
- Waits for Postgres in the container to be ready and applies SQL files from `schema/` in a controlled order:
  - sequences → sequence_values → tables (table.sql) → constraints/indexes/fkeys → other objects
- Suppresses normal psql stdout and prints colored success/failure messages + error detail on failure.
- Configurable: CONTAINER_NAME, POSTGRES_USER, POSTGRES_DB, SCHEMA_NAME. The script creates the target schema if needed.
- Usage:
  - Ensure container is running (postgis-init.sh)
  - chmod +x postgis-migrate.sh
  - ./postgis-migrate.sh

7) postgis-delete.sh
- Cleanup script with two modes:
  - hard — stop/remove the PostGIS container and remove the Docker volume (full destructive cleanup)
  - soft — keep container, but drop & recreate the target database to a fresh state and recreate common extensions and a default schema
- Interactive by default; supports non-interactive: `--force hard` or `--force soft`.
- Example:
  - chmod +x postgis-delete.sh
  - ./postgis-delete.sh        # interactive prompt for h/s
  - ./postgis-delete.sh --force hard
  - ./postgis-delete.sh --force soft

8) postgis-oc-migrate.sh
- Runs SQL files against an external Postgres instance (host+port) using local `psql`. Designed for use when the database is accessible via port-forwarding (OpenShift oc port-forward) or when running Postgres on host.
- Configurable variables at top: SCHEMA_NAME, PGHOST, PGPORT, PGUSER, PGDATABASE.
- Usage examples:
  - Local Postgres on forwarded port:
    - Start OpenShift port-forward (example):
      - oc port-forward svc/my-db 5434:5432 -n myproject
    - Then:
      - chmod +x postgis-oc-migrate.sh
      - ./postgis-oc-migrate.sh
  - Notes:
    - Requires `psql` available on the host and network access to PGHOST:PGPORT.
    - Useful for applying SQL during OpenShift testing (port-forward the service/pod to a local port and run this script).

Recommended workflow
--------------------
1. Export from Oracle (use dockerized export if you do not have Ora2Pg locally):
   - ./export_schema_docker.sh
   - or for filtered export: ./export_schema_filter_tables_docker.sh (set config/app_tables.txt)

2. Start a fresh PostGIS container:
   - ./postgis-init.sh

3. Ensure the DB has required extensions if not created by migration:
   - docker exec -i postgis_nr_silva psql -U postgres -d nr_silva -c 'CREATE EXTENSION IF NOT EXISTS postgis;'
   - docker exec -i postgis_nr_silva psql -U postgres -d nr_silva -c 'CREATE EXTENSION IF NOT EXISTS pgcrypto;'
   - docker exec -i postgis_nr_silva psql -U postgres -d nr_silva -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'

4. Run migration:
   - ./postgis-migrate.sh
   - or if using port-forward / external PG: ./postgis-oc-migrate.sh (after port-forward)

5. If you need a clean slate:
   - Soft reset (keeps container): ./postgis-delete.sh --force soft
   - Hard delete (remove container + volume): ./postgis-delete.sh --force hard
